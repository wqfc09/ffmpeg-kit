name: Build Custom FFmpeg Android

on:
  workflow_dispatch: 
  push:
    paths:
      - '.github/workflows/Custom_Android_Build.yaml'

jobs:
  build-android-lite:
    name: Build Lite Android AAR
    runs-on: ubuntu-24.04 # 使用最新环境

    steps:
      # 1. 拉取 FFmpeg Kit 官方源码
      - name: Checkout FFmpeg Kit
        uses: actions/checkout@v4
        with:
          repository: wqfc09/ffmpeg-kit
          ref: main 

      # 2. 配置 JDK (Gradle 打包需要)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. 配置 Android NDK
      - name: Set up Android NDK Environment
        run: |
          # 自动定位系统预装的 NDK 路径，通常路径类似 /usr/local/lib/android/sdk/ndk/25.x.xxxx
          
          NDK_PATH=$(ls -d $ANDROID_SDK_ROOT/ndk/* | tail -1)
          
          # 将其写入全局环境变量，供后续 Step 使用
          
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "Using NDK: $NDK_PATH"
          echo "Using SDK: $ANDROID_SDK_ROOT"

      # 4. 安装编译依赖
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git autoconf automake libtool pkg-config \
            tcl libass-dev libfreetype6-dev libsdl2-dev libva-dev \
            libvdpau-dev libvorbis-dev libxcb1-dev libxcb-shm0-dev \
            libxcb-xfixes0-dev zlib1g-dev nasm yasm cmake gperf bison flex

      # 5. 执行编译脚本
      - name: Build with Custom Arguments
        env:
          # 必须在这里显式重新声明映射，确保变量进入该步骤的 Shell 环境
          ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_ROOT }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          FFMPEG_KIT_FFMPEG_CONFIGURE_FLAGS: >-
            --enable-version3 --disable-gpl --disable-nonfree
            --disable-all
            --enable-ffmpeg --enable-ffprobe
            --enable-avcodec --enable-avformat --enable-avfilter --enable-avdevice --enable-swresample --enable-swscale
            --enable-jni
            --enable-mediacodec
            --enable-hwaccel=h264_mediacodec,hevc_mediacodec,vp9_mediacodec,av1_mediacodec
            --enable-decoder=h264_mediacodec,hevc_mediacodec,vp9_mediacodec,av1_mediacodec,h264,hevc,vp9,av1,aac,mp3,wrapped_avframe
            --enable-encoder=h264_mediacodec,hevc_mediacodec,vp9_mediacodec,av1_mediacodec,aac,wrapped_avframe
            --enable-parser=h264,hevc,vp9,av1,aac
            --enable-indev=lavfi
            --enable-filter=split,scale,format,null,unsharp,eq,hqdn3d,hwupload,hwdownload,testsrc2,color,buffer,buffersink,transpose,crop,fps
            --enable-demuxer=lavfi,avi,mov,mp4,m4a,yuv4mpegpipe,h264,hevc,aac,mp3,matroska
            --enable-muxer=avi,mp4,mov,null,image2
            --enable-protocol=file,http,https,tcp,udp
            
        run: |
          # --- 核心魔改：针对 NDK 29+ 禁用 cpu-features ---
          # 1. 在 android.mk 模板中注释掉 cpu-features 的引用
          find . -name "Android.mk" -exec sed -i 's/$(call import-module,android\/cpufeatures)/# disabled cpufeatures/g' {} +   
          # 2. 在 main 编译脚本中强行跳过 cpu-features 阶段，这一步是为了防止脚本因为找不到该模块而直接中断
          sed -i 's/build_cpu_features/# build_cpu_features/g' scripts/main-android.sh
          
          chmod +x android.sh
          ./android.sh \
            --disable-arm-v7a \
            --disable-arm-v7a-neon \
            --disable-x86 \
            --disable-x86-64 \
            --enable-android-zlib

      # 6. 上传产物 (AAR)
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-android-custom
          path: prebuilt/android-aar/**/*.aar
          if-no-files-found: error
