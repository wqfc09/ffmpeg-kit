name: Build Custom FFmpeg iOS (WebP)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/ffmpeg_ios_custom_build.yml"

jobs:
  build-ios:
    name: Build iOS XCFramework (webp)
    runs-on: macos-14

    steps:
      - name: Checkout FFmpeg Kit Fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.ffmpeg_kit_repository || 'wqfc09/ffmpeg-kit' }}
          ref: ${{ github.event.inputs.ffmpeg_kit_ref || 'main' }}
          fetch-depth: 1

      - name: Show Xcode Version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Install Build Dependencies
        run: |
          brew update
          brew install autoconf automake libtool pkg-config cmake nasm yasm

      - name: Build with Custom Flags
        env:
          FFMPEG_KIT_FFMPEG_CONFIGURE_FLAGS: >-
            --enable-version3 --disable-gpl --disable-nonfree
            --disable-all
            --enable-ffmpeg --enable-ffprobe
            --enable-avcodec --enable-avformat --enable-avfilter --enable-avdevice --enable-avutil --enable-swresample --enable-swscale
            --enable-videotoolbox
            --enable-protocol=file,pipe,http,https,tcp,udp
            --enable-demuxer=mov,mp4,m4a,matroska,avi,webp,image2,h264,hevc,aac,mp3
            --enable-muxer=mp4,mov,image2,webp,null
            --enable-parser=h264,hevc,aac,mpegaudio
            --enable-decoder=h264,hevc,vp9,av1,aac,mp3,webp,mjpeg,png
            --enable-encoder=h264_videotoolbox,hevc_videotoolbox,aac,libwebp,libwebp_anim
            --enable-filter=split,scale,format,null,fps,crop,transpose
            --enable-libwebp
        run: |
          chmod +x ios.sh
          ./ios.sh --disable-armv7 --disable-i386 | tee build.log

      - name: Check Build Outputs
        run: |
          echo "=== XCFramework / Framework Files ==="
          find . -name "*.xcframework" -o -name "*.framework" | head -n 200
          echo "=== WebP Signals in Log ==="
          grep -Ei "libwebp|webp" build.log | tail -n 40 || true

      - name: Print Build Logs on Failure
        if: failure()
        run: |
          echo "=== Build Log (tail 500) ==="
          [ -f build.log ] && tail -n 500 build.log
          echo "=== config.log tail ==="
          find . -name "config.log" -exec sh -c 'echo "--- $1 ---"; tail -n 200 "$1"' _ {} \;

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-ios-custom-webp
          if-no-files-found: error
          path: |
            **/*.xcframework/**
            **/*.framework/**
            prebuilt/**/*
            build.log
